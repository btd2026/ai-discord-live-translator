<Window x:Class="DiscordCaptionOverlay.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:DiscordCaptionOverlay.ViewModels"
        xmlns:controls="clr-namespace:DiscordCaptionOverlay.Controls"
        xmlns:local="clr-namespace:DiscordCaptionOverlay"
        mc:Ignorable="d"
        Title="AI Discord Live Translator"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        ResizeMode="CanResizeWithGrip"
        Width="320" Height="540" Topmost="True"
        WindowStartupLocation="Manual">
  <Window.Resources>
    <Style TargetType="Thumb" x:Key="GripStyle">
      <Setter Property="Width" Value="0"/>
      <Setter Property="Height" Value="0"/>
    </Style>
    <!-- Minimal button style for titlebar dots: no default hover box, subtle scale on hover/press -->
    <Style TargetType="Button" x:Key="CircleTitleButton">
      <Setter Property="Background" Value="Transparent"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="Padding" Value="0"/>
      <Setter Property="Cursor" Value="Hand"/>
      <Setter Property="Focusable" Value="False"/>
      <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
      <Setter Property="OverridesDefaultStyle" Value="True"/>
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="Button">
            <Grid>
              <ContentPresenter x:Name="content"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                RenderTransformOrigin="0.5,0.5">
                <ContentPresenter.RenderTransform>
                  <ScaleTransform ScaleX="1" ScaleY="1"/>
                </ContentPresenter.RenderTransform>
              </ContentPresenter>
            </Grid>
            <ControlTemplate.Triggers>
              <Trigger Property="IsMouseOver" Value="True">
                <Setter TargetName="content" Property="RenderTransform">
                  <Setter.Value>
                    <ScaleTransform ScaleX="1.06" ScaleY="1.06"/>
                  </Setter.Value>
                </Setter>
              </Trigger>
              <Trigger Property="IsPressed" Value="True">
                <Setter TargetName="content" Property="RenderTransform">
                  <Setter.Value>
                    <ScaleTransform ScaleX="0.94" ScaleY="0.94"/>
                  </Setter.Value>
                </Setter>
              </Trigger>
              <Trigger Property="IsEnabled" Value="False">
                <Setter TargetName="content" Property="Opacity" Value="0.5"/>
              </Trigger>
            </ControlTemplate.Triggers>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
    </Style>
  </Window.Resources>
  <Grid>
    <!-- background layer -->
    <Border Background="{DynamicResource HeaderBackground}" CornerRadius="12" Margin="4" MouseDown="Background_MouseDown">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="32"/>
          <RowDefinition Height="Auto"/> <!-- Metrics panel -->
          <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <DockPanel Grid.Row="0" LastChildFill="False" Margin="8,4,8,4">
          <TextBlock Text="AI Discord Live Translator" FontFamily="{StaticResource AppFont}" Foreground="{DynamicResource PrimaryText}" VerticalAlignment="Center"/>
          <!-- Window controls -->
          <Button x:Name="CloseButton" DockPanel.Dock="Right" VerticalAlignment="Center" Margin="2,0,0,0"
                  Width="12" Height="12" Style="{StaticResource CircleTitleButton}"
                  Click="CloseButton_Click" ToolTip="Close application">
            <Ellipse Width="10" Height="10" Fill="#FF5F56" Stroke="#E0443E" StrokeThickness="0.5"/>
          </Button>
          <Button x:Name="MinimizeButton" DockPanel.Dock="Right" VerticalAlignment="Center" Margin="2,0,0,0"
                  Width="12" Height="12" Style="{StaticResource CircleTitleButton}"
                  Click="MinimizeButton_Click" ToolTip="Minimize window">
            <Ellipse Width="10" Height="10" Fill="#FFBD2E" Stroke="#DEA123" StrokeThickness="0.5"/>
          </Button>
          <Ellipse Width="10" Height="10" Margin="8,0,0,0" Fill="{Binding ConnectionStatus, Converter={StaticResource ConnectionToBrushConverter}}" DockPanel.Dock="Right" VerticalAlignment="Center"/>
          
          <!-- Language selector -->
          <Button x:Name="LangButton" DockPanel.Dock="Right" VerticalAlignment="Center" Margin="8,0,0,0"
                  Padding="6,2" Background="Transparent" BorderThickness="0" Foreground="{DynamicResource SecondaryText}"
                  Click="LangButton_Click" ToolTip="Select target translation language">
            <StackPanel Orientation="Horizontal">
              <TextBlock Text="Lang:" Margin="0,0,4,0"/>
              <TextBlock x:Name="LangButtonLabel" Text="multi" FontWeight="SemiBold"/>
            </StackPanel>
            <Button.ContextMenu>
              <ContextMenu>
                <MenuItem Header="Multilingual (multi)" Tag="multi" Click="LangMenuItem_Click"/>
                <Separator/>
                <MenuItem Header="English (en)" Tag="en" Click="LangMenuItem_Click"/>
                <MenuItem Header="English (en-US)" Tag="en-US" Click="LangMenuItem_Click"/>
                <MenuItem Header="English (en-AU)" Tag="en-AU" Click="LangMenuItem_Click"/>
                <MenuItem Header="English (en-GB)" Tag="en-GB" Click="LangMenuItem_Click"/>
                <MenuItem Header="English (en-IN)" Tag="en-IN" Click="LangMenuItem_Click"/>
                <MenuItem Header="English (en-NZ)" Tag="en-NZ" Click="LangMenuItem_Click"/>
                <Separator/>
                <MenuItem Header="German (de)" Tag="de" Click="LangMenuItem_Click"/>
                <MenuItem Header="Dutch (nl)" Tag="nl" Click="LangMenuItem_Click"/>
                <MenuItem Header="Swedish (sv)" Tag="sv" Click="LangMenuItem_Click"/>
                <MenuItem Header="Swedish (sv-SE)" Tag="sv-SE" Click="LangMenuItem_Click"/>
                <MenuItem Header="Danish (da)" Tag="da" Click="LangMenuItem_Click"/>
                <MenuItem Header="Danish (da-DK)" Tag="da-DK" Click="LangMenuItem_Click"/>
                <Separator/>
                <MenuItem Header="Spanish (es)" Tag="es" Click="LangMenuItem_Click"/>
                <MenuItem Header="Spanish (es-419)" Tag="es-419" Click="LangMenuItem_Click"/>
                <MenuItem Header="French (fr)" Tag="fr" Click="LangMenuItem_Click"/>
                <MenuItem Header="French (fr-CA)" Tag="fr-CA" Click="LangMenuItem_Click"/>
                <MenuItem Header="Portuguese (pt)" Tag="pt" Click="LangMenuItem_Click"/>
                <MenuItem Header="Portuguese (pt-BR)" Tag="pt-BR" Click="LangMenuItem_Click"/>
                <MenuItem Header="Portuguese (pt-PT)" Tag="pt-PT" Click="LangMenuItem_Click"/>
              </ContextMenu>
            </Button.ContextMenu>
          </Button>
          <!-- Metrics toggle button -->
          <Button x:Name="MetricsToggle" Content="ðŸ“Š" Width="20" Height="20" Margin="4,0,0,0" DockPanel.Dock="Right" VerticalAlignment="Center" 
                  FontSize="10" Background="Transparent" BorderThickness="0" Foreground="{DynamicResource SecondaryText}"
                  Click="MetricsToggle_Click" MouseRightButtonUp="MetricsToggle_RightClick" ToolTip="Toggle metrics display (right-click to reset)"/>
        </DockPanel>

        <!-- Metrics Panel (collapsible) -->
        <Border x:Name="MetricsPanel" Grid.Row="1" Background="{DynamicResource HeaderBackground}" 
                BorderBrush="{DynamicResource RowBorder}" BorderThickness="0,1,0,0" 
                Visibility="Collapsed" Margin="4,0,4,0">
          <StackPanel Margin="8,4,8,4" DataContext="{Binding Metrics}">
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
              </Grid.ColumnDefinitions>
              <StackPanel Grid.Column="0">
                <TextBlock Text="{Binding TotalEvents, StringFormat='Events: {0}'}" FontSize="10" Foreground="{DynamicResource SecondaryText}"/>
                <TextBlock Text="{Binding OverflowExpansions, StringFormat='Expansions: {0}'}" FontSize="10" Foreground="{DynamicResource SecondaryText}"/>
                <TextBlock Text="{Binding LateRespawns, StringFormat='Respawns: {0}'}" FontSize="10" Foreground="{DynamicResource SecondaryText}"/>
              </StackPanel>
              <StackPanel Grid.Column="1">
                <TextBlock Text="{Binding DroppedOutOfOrder, StringFormat='Dropped: {0}'}" FontSize="10" Foreground="{DynamicResource SecondaryText}"/>
                <TextBlock Text="{Binding AvgCharsPerSecond, StringFormat='CPS: {0:F1}'}" FontSize="10" Foreground="{DynamicResource SecondaryText}"/>
                <TextBlock Text="{Binding UptimeFormatted, StringFormat='Up: {0}'}" FontSize="10" Foreground="{DynamicResource SecondaryText}"/>
              </StackPanel>
            </Grid>
          </StackPanel>
        </Border>

        <!-- List -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Hidden">
          <ItemsControl ItemsSource="{Binding Speakers}" Margin="2">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <StackPanel/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate DataType="{x:Type vm:SpeakerViewModel}">
                <controls:SpeakerRow/>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </Grid>
    </Border>
  </Grid>
</Window>
