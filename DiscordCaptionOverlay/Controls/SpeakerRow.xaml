<UserControl x:Class="DiscordCaptionOverlay.Controls.SpeakerRow"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:DiscordCaptionOverlay.ViewModels"
             xmlns:local="clr-namespace:DiscordCaptionOverlay.Controls"
             MinHeight="68" Margin="6,6,6,0">
  <UserControl.Resources>
    <!-- style toggles wrapping based on IsExpanded -->
    <Style x:Key="LaneTextStyle" TargetType="TextBlock">
      <Setter Property="FontFamily" Value="{Binding LaneFontFamily}" />
      <Setter Property="FontSize" Value="{Binding LaneFontSize}" />
      <Setter Property="TextWrapping" Value="NoWrap"/>
      <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
      <Style.Triggers>
        <DataTrigger Binding="{Binding IsExpanded}" Value="True">
          <Setter Property="TextWrapping" Value="Wrap"/>
          <Setter Property="TextTrimming" Value="None"/>
        </DataTrigger>
      </Style.Triggers>
    </Style>
  </UserControl.Resources>
  
  <Grid>
    <Border Background="{DynamicResource RowFill}" BorderBrush="{DynamicResource RowBorder}" BorderThickness="1" CornerRadius="12"/>
    <Grid Margin="10,10,10,10">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="4"/> <!-- speaking accent -->
        <ColumnDefinition Width="42"/> <!-- avatar -->
        <ColumnDefinition Width="*" />
      </Grid.ColumnDefinitions>

      <Border Grid.Column="0" Background="{Binding ColorHex}" CornerRadius="2" Width="2" HorizontalAlignment="Left" Visibility="{Binding IsSpeaking, Converter={StaticResource BooleanToVisibilityConverter}}"/>

      <!-- Avatar: show profile image if available; fallback to color -->
      <Grid Grid.Column="1" Width="36" Height="36">
        <!-- Fallback color circle -->
        <Ellipse Fill="{Binding ColorHex}"/>
        <!-- Image circle on top -->
        <Ellipse>
          <Ellipse.Fill>
            <ImageBrush ImageSource="{Binding AvatarUrl}" Stretch="UniformToFill"/>
          </Ellipse.Fill>
        </Ellipse>
        <Grid.Effect>
          <DropShadowEffect BlurRadius="8" Opacity="0.25"/>
        </Grid.Effect>
        <Grid.Clip>
          <EllipseGeometry Center="18,18" RadiusX="18" RadiusY="18"/>
        </Grid.Clip>
      </Grid>

      <!-- Content area with expandable text lanes -->
      <Grid x:Name="ContentGrid" Grid.Column="2" Margin="8,0,0,0">
        <Grid.RowDefinitions>
          <RowDefinition Height="20"/> <!-- Username -->
          <RowDefinition Height="6"/>  <!-- Spacer -->
          <RowDefinition Height="Auto"/> <!-- Final/Translation line -->
          <RowDefinition Height="4"/>  <!-- Small spacer -->
          <RowDefinition Height="Auto"/> <!-- Interim line -->
        </Grid.RowDefinitions>

        <!-- Username -->
        <TextBlock Grid.Row="0" Text="{Binding Username}" 
                   FontFamily="{StaticResource AppFont}" 
                   FontWeight="SemiBold" 
                   FontSize="14" 
                   Foreground="{DynamicResource PrimaryText}" />

        <!-- Final/Translation Text (top line) -->
        <TextBlock x:Name="FinalText" Grid.Row="2"
                   Text="{Binding FinalType.DisplayText}">
          <TextBlock.Style>
            <Style TargetType="TextBlock" BasedOn="{StaticResource LaneTextStyle}">
              <Setter Property="Foreground" Value="{DynamicResource PrimaryText}"/>
              <Setter Property="FontStyle" Value="Normal"/>
              <Setter Property="FontWeight" Value="Bold"/>
              <Style.Triggers>
                <!-- When not finalized yet, keep bold but use secondary color (no italics) -->
                <DataTrigger Binding="{Binding IsFinalShowing}" Value="False">
                  <Setter Property="Foreground" Value="{DynamicResource SecondaryText}"/>
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </TextBlock.Style>
        </TextBlock>

        <!-- Interim Text (bottom line) -->
        <TextBlock x:Name="InterimText" Grid.Row="4"
                   Text="{Binding InterimType.DisplayText}"
                   Style="{StaticResource LaneTextStyle}"
                   FontSize="{Binding InterimFontSize}"
                   Foreground="{DynamicResource SecondaryText}"
                   FontStyle="Italic"/>
      </Grid>
    </Grid>
  </Grid>
</UserControl>
